---
title: "Modeling Exoplanet Detection Rates and Planetary Properties"
output: html_document
author: "Aleks Likhoshva, Pratyush Jha"
---
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(rstan)
library(rstanarm)
library(bayesplot)
library(dplyr)
library(tidyr)
```


# Discoveries Per Year (Discrete Variable)
## Load in Data, Clean
```{r}
base_url <- "https://exoplanetarchive.ipac.caltech.edu/TAP/sync"
query_string <- "select+pl_name,disc_year,pl_rade,pl_orbper,st_met,st_teff,discoverymethod+from+ps+where+default_flag=1&format=csv"
full_url <- paste0(base_url, "?query=", query_string)

raw_planets <- read_csv(full_url)

clean_data <- raw_planets %>%
  mutate(
    log_radius = log(pl_rade),
    log_period = log(pl_orbper),
    st_teff_k = st_teff / 1000
  ) %>%
  filter(
    !is.na(disc_year),
    !is.na(log_radius),
    !is.na(log_period),
    !is.na(st_met),
    !is.na(st_teff_k),
    !is.na(discoverymethod)
  )
```


## Stan model, MCMC
We model:
$$y_i \sim Poisson(\lambda)$$
$$\lambda \sim Gamma(2,0.1)$$

```{r}
yearly_counts <- clean_data %>%
  count(disc_year) %>%
  rename(n_planets = n)

head(yearly_counts)

poisson_stan_code <- "
data {
  int<lower=0> N;
  int<lower=0> y[N];
}
parameters {
  real<lower=0> lambda;
}
model {
  lambda ~ gamma(2, 0.1);
  y ~ poisson(lambda);
}
"

stan_data <- list(
  N = nrow(yearly_counts),
  y = yearly_counts$n_planets
)

poisson_fit <- stan(
  model_code = poisson_stan_code,
  data = stan_data,
  iter = 2000,
  chains = 4
)
```

## Prior Diagnostics, Trace Plot
```{r}
print(poisson_fit, pars = "lambda")
color_scheme_set("brightblue")

mcmc_trace(
  as.array(poisson_fit),
  pars = "lambda"
)
```

## Density Plot
```{r}
mcmc_dens(as.array(poisson_fit), pars = "lambda")
```
 
## Autocorrelation Plot
```{r}
mcmc_acf(as.array(poisson_fit), pars = "lambda")
```

## R-Hat, Effective Sample Size
```{r}
summary(poisson_fit)$summary[, c("Rhat", "n_eff")]
```


## Closed Form Posterior
We model: 

$$\lambda | y \sim Gamma(a + \Sigma y, \beta + N)$$

```{r}
alpha_prior <- 2
beta_prior <- 0.1

sum_y <- sum(yearly_counts$n_planets)
N <- nrow(yearly_counts)
alpha_post <- alpha_prior + sum_y
beta_post <- beta_prior + N

#posterior mean
alpha_post / beta_post
```

## Comparison with MCMC mean
```{r}
posterior_samples <- extract(poisson_fit)$lambda
mean(posterior_samples)
```

Here, we modeled the yearly number of exoplanet discoveries using a Poisson likelihood with $Gamma (2,0.1)$ prior on the rate parameter $\gamma$. 
We estimated the posterior distribution using Hamiltonian Monte Carlo via Stan. Trace plots, density plots, and autocorrelation diagnostics indicate good chain mixing, given R-hat values hover around 1.00 and effective sample sizes appear high.
We also derived the closed-form Gamma posterior due to conjugacy and found strong agreement between the theoretical posterior mean and the MCMC based posterior mean, confirming correct model implementaiton and convergence

# Orbital Period in Log Space (Continous Variable)
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(rstan)
library(rstanarm)
library(bayesplot)
```

```{r}
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
rstan_options(threads_per_chain = 2)
```


```{r}
base_url <- "https://exoplanetarchive.ipac.caltech.edu/TAP/sync"
query_string <- "select+pl_name,disc_year,pl_rade,pl_orbper,st_met,st_teff,discoverymethod,st_mass,sy_pnum+from+ps+where+default_flag=1&format=csv"
full_url <- paste0(base_url, "?query=", query_string)

raw_planets <- read_csv(full_url)

clean_data <- raw_planets %>%
  mutate(
    log_radius = log(pl_rade),
    log_period = log(pl_orbper),
    log_st_mass = log(st_mass),
    st_teff_k = st_teff / 1000,
    method_group = fct_lump(discoverymethod, n = 3) 
  ) %>%
  filter(
    !is.na(disc_year),
    !is.na(log_radius),
    !is.na(log_period),
    !is.na(st_met),
    !is.na(st_teff_k),
    !is.na(discoverymethod),
    !is.na(log_st_mass)
  )

print(nrow(clean_data))
head(clean_data)
```
Continuos Parameter Estimation
```{r}
y_val <- clean_data$log_period
N_val <- length(y_val)
```

```{r}
mu_prior_mean <- 5.0
mu_prior_sd   <- 5.0 
```

```{r}
stan_data_continuous <- list(
  N    = N_val,
  y    = y_val,
  mu0  = mu_prior_mean,
  tau0 = mu_prior_sd
)

fit_continuous <- stan(
  model_code = "
    data {
      int<lower=0> N;
      vector[N] y;
      real mu0;
      real tau0;
    }
    parameters {
      real mu;
      real<lower=0> sigma;
    }
    model {
      // Priors
      mu ~ normal(mu0, tau0);
      sigma ~ cauchy(0, 5); // Half-cauchy for scale
      
      // Likelihood
      y ~ normal(mu, sigma);
    }
  ",
  data = stan_data_continuous,
  iter = 10000,
  chains = 4
)
```

```{r}
print(fit_continuous, pars = c("mu", "sigma"))

mcmc_trace(fit_continuous, pars = "mu") + ggtitle("Trace Plot for Mu (Log Period)")
mcmc_dens(fit_continuous, pars = "mu") + ggtitle("Density Plot for Mu (Log Period)")
mcmc_acf(fit_continuous, pars = c("mu", "sigma")) + ggtitle("Autocorrelation for Mu and Sigma")
```


```{r}
sigma_data <- sd(y_val)
y_bar      <- mean(y_val)

prior_prec <- 1 / (mu_prior_sd^2)
data_prec  <- N_val / (sigma_data^2)

post_var_theo <- 1 / (prior_prec + data_prec)

post_mean_theo <- post_var_theo * ( (mu_prior_mean * prior_prec) + (y_bar * data_prec) )

mcmc_mean <- summary(fit_continuous)$summary["mu", "mean"]

cat("Comparison of Posterior Means for Log Period:\n")
cat(sprintf("Theoretical (Approx): %.4f\n", post_mean_theo))
cat(sprintf("MCMC Estimate (Stan): %.4f\n", mcmc_mean))
```



```{r}
fit_stanarm <- stan_glm(
  log_period ~ log_st_mass + st_teff_k + st_met + sy_pnum,
  data = clean_data,
  family = gaussian(),
  
  prior = normal(location = 0, scale = 2.5, autoscale = TRUE),
  prior_intercept = normal(location = 0, scale = 10, autoscale = TRUE),
  prior_aux = exponential(rate = 1, autoscale = TRUE), 
  
  chains = 4,
  iter = 2000,
  seed = 123
)
```


```{r}

summary(fit_stanarm)

plot(fit_stanarm, "trace", pars = "(Intercept)")
plot(fit_stanarm, "trace", pars = "sy_pnum")

plot(fit_stanarm, "acf", pars = "sy_pnum")

plot(fit_stanarm, "areas", prob = 0.95, prob_outer = 1)
```