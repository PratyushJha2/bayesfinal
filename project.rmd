---
title: ""
output: html_document
---
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(rstan)
library(rstanarm)
library(bayesplot)
library(dplyr)
library(tidyr)
```

## Load in Data, Clean
```{r}
base_url <- "https://exoplanetarchive.ipac.caltech.edu/TAP/sync"
query_string <- "select+pl_name,disc_year,pl_rade,pl_orbper,st_met,st_teff,discoverymethod+from+ps+where+default_flag=1&format=csv"
full_url <- paste0(base_url, "?query=", query_string)

raw_planets <- read_csv(full_url)

clean_data <- raw_planets %>%
  mutate(
    log_radius = log(pl_rade),
    log_period = log(pl_orbper),
    st_teff_k = st_teff / 1000
  ) %>%
  filter(
    !is.na(disc_year),
    !is.na(log_radius),
    !is.na(log_period),
    !is.na(st_met),
    !is.na(st_teff_k),
    !is.na(discoverymethod)
  )
```


## Stan model, MCMC
We model:
$$y_i \sim Poisson(\lambda)$$
$$\lambda \sim Gamma(2,0.1)$$

```{r}
yearly_counts <- clean_data %>%
  count(disc_year) %>%
  rename(n_planets = n)

head(yearly_counts)

poisson_stan_code <- "
data {
  int<lower=0> N;
  int<lower=0> y[N];
}
parameters {
  real<lower=0> lambda;
}
model {
  lambda ~ gamma(2, 0.1);
  y ~ poisson(lambda);
}
"

stan_data <- list(
  N = nrow(yearly_counts),
  y = yearly_counts$n_planets
)

poisson_fit <- stan(
  model_code = poisson_stan_code,
  data = stan_data,
  iter = 2000,
  chains = 4
)
```

## Prior Diagnostics, Trace Plot
```{r}
print(poisson_fit, pars = "lambda")
color_scheme_set("brightblue")

mcmc_trace(
  as.array(poisson_fit),
  pars = "lambda"
)
```

## Density Plot
```{r}
mcmc_dens(as.array(poisson_fit), pars = "lambda")
```
 
## Autocorrelation Plot
```{r}
mcmc_acf(as.array(poisson_fit), pars = "lambda")
```

## R-Hat, Effective Sample Size
```{r}
summary(poisson_fit)$summary[, c("Rhat", "n_eff")]
```


## Closed Form Posterior
We model: 

$$\lambda | y \sim Gamma(a + \Sigma y, \beta + N)$$

```{r}
alpha_prior <- 2
beta_prior <- 0.1

sum_y <- sum(yearly_counts$n_planets)
N <- nrow(yearly_counts)
alpha_post <- alpha_prior + sum_y
beta_post <- beta_prior + N

#posterior mean
alpha_post / beta_post
```

## Comparison with MCMC mean
```{r}
posterior_samples <- extract(poisson_fit)$lambda
mean(posterior_samples)
```

Here, we modeled the yearly number of exoplanet discoveries using a Poisson likelihood with $Gamma (2,0.1)$ prior on the rate parameter $\gamma$. 
We estimated the posterior distribution using Hamiltonian Monte Carlo via Stan. Trace plots, density plots, and autocorrelation diagnostics indicate good chain mixing, given R-hat values hover around 1.00 and effective sample sizes appear high.
We also derived the closed-form Gamma posterior due to conjugacy and found strong agreement between the theoretical posterior mean and the MCMC based posterior mean, confirming correct model implementatoin and convergencead